# Metadata Migration Guide

## Overview

In May 2025, we migrated the user metadata from a JSONB column in the `users` table to a dedicated `user_metadata` table. This document explains the changes, why they were made, and how to work with the new structure.

## Background

Previously, additional user profile information (like address details and website) was stored in a `metadata` JSONB column in the `users` table. This approach caused issues with the Android app's registration and login functionality, as the mobile app had difficulty handling the JSONB column.

## Changes Made

### 1. New Table Structure

We created a new `user_metadata` table with the following structure:

```sql
CREATE TABLE IF NOT EXISTS user_metadata (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
  website TEXT,
  address_line1 TEXT,
  address_line2 TEXT,
  city TEXT,
  county TEXT,
  country TEXT DEFAULT 'United Kingdom',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  CONSTRAINT user_metadata_user_id_unique UNIQUE (user_id)
);
```

### 2. Data Migration

All data from the `metadata` JSONB column was migrated to the new `user_metadata` table, with each JSON field mapped to a dedicated column.

### 3. Schema Cleanup

The original `metadata` column was removed from the `users` table after all data was safely migrated.

### 4. Security Policies

Row Level Security (RLS) policies were implemented on the new table to maintain the same security model:

```sql
ALTER TABLE user_metadata ENABLE ROW LEVEL SECURITY;

CREATE POLICY user_metadata_select_policy ON user_metadata 
  FOR SELECT USING (auth.uid()::text = user_id);

CREATE POLICY user_metadata_update_policy ON user_metadata
  FOR UPDATE USING (auth.uid()::text = user_id);

CREATE POLICY user_metadata_insert_policy ON user_metadata
  FOR INSERT WITH CHECK (auth.uid()::text = user_id);
```

## Working with the New Structure

### Frontend Access

The frontend code has been updated to work with the new structure. The main changes are in the `useSupabaseProfile.ts` hook, which now:

1. Joins the `users` and `user_metadata` tables in queries
2. Accesses metadata fields from the joined object structure
3. Updates both tables when profile changes are made

Example of fetching a profile:

```typescript
// Old approach (deprecated)
const { data } = await supabase
  .from('users')
  .select('*')
  .filter('user_id', 'eq', userId);

const metadata = data[0].metadata || {};
const city = metadata.city;

// New approach
const { data } = await supabase
  .from('users')
  .select(`
    *,
    user_metadata (id, website, address_line1, address_line2, city, county, country)
  `)
  .filter('user_id', 'eq', userId);

const userMetadata = data[0].user_metadata || {};
const city = userMetadata.city;
```

### Benefits

1. **Improved Mobile Compatibility**: Android app registration/login now works correctly
2. **Better Schema Design**: Properly normalized database structure
3. **Type Safety**: Direct column access instead of JSON property access
4. **Query Performance**: Improved query performance for metadata fields
5. **Maintainability**: Clearer code and database structure

## Helper Functions

We've also created database functions to help with common metadata operations:

1. `get_user_metadata(user_id_param TEXT)`: Returns metadata for a specific user
2. `update_user_metadata(user_id_param TEXT, ...)`: Updates metadata fields for a user

These functions can be used for simplified access to metadata when needed.
